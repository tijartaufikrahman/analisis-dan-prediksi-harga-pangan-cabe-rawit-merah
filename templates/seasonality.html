{% extends "layout.html" %}
{% block title %}Sistem Prediksi Harga{% endblock %}

{% block content %}

        

    <style>

.page-hero {
    background: linear-gradient(135deg, #0093AD, #006F84);
    color: white;
    /* padding: 60px 20px; */
    padding-top: 60px;
    padding-bottom: 90px;

    border-radius: 0 0 40px 40px;
}

.page-hero h2 {
    font-weight: 600;
    letter-spacing: .5px;
}

.page-hero p {
    opacity: .9;
    font-size: 15px;
    max-width: 650px;
    margin: 0 auto;
}

.form-wrapper {
    margin-top: -50px;
}

.custom-card {
    border-radius: 18px;
    transition: .3s ease;
}

.custom-card:hover {
    transform: translateY(-2px);
}

.custom-select {
    border-radius: 12px;
    padding: 10px 15px;
    border: 1px solid #e5e5e5;
}

.btn-main {
    background: linear-gradient(135deg, #0093AD, #007A8C);
    border: none;
    border-radius: 12px;
    padding: 10px 25px;
    transition: .3s;
}

.btn-main:hover {
    opacity: .92;
    transform: scale(1.03);
}

.step-box {
    background: #f8f9fa;
    border-radius: 14px;
    padding: 15px;
    text-align: center;
    font-size: 13px;
    transition: .3s;
    font-weight: 500;
}

.step-box:hover {
    background: #e9f7fa;
}

.highlight-text {
    font-weight: 600;
}

</style>

<style>
    /* ================= ACCORDION PREMIUM STYLE ================= */
/* ================= ACCORDION MODERN ACTIVE ================= */

.accordion-item {
    border: none;
    border-radius: 10px !important;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    margin-bottom: 20px;
}

/* Default button */
.accordion-button {
    font-weight: 600;
    font-size: 15px;
    padding: 18px 22px;
    background: #ffffff;
    transition: all 0.3s ease;
}

/* Active (terbuka) */
.accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #0093AD, #007A8C);
    color: #ffffff;
}

/* Hilangkan focus biru bawaan bootstrap */
.accordion-button:focus {
    box-shadow: none;
}

/* Body styling */


/* ================= ACCORDION PRO STYLE ================= */



</style>


<style>
.modal-backdrop {
    background-color: rgba(237, 234, 234, 0.5) !important;
}

.modal-backdrop.show {
    opacity: 1 !important;
}
 */

</style>

<style>
    .accordion-button::after {
    filter: invert(1); /* jadi putih */
}

</style>


























<!-- HERO SECTION -->
<div class="page-hero text-center">
    <h2>Sistem Prediksi Harga Komoditas Cabe Rawit Merah <br>di Kota Bandung</h2>
    <p>
        <!-- Sistem ini digunakan untuk menganalisis dan memprediksi 
        <span class="highlight-text">harga Cabe Rawit Merah di Kota Bandung</span> 
        menggunakan metode STL dan SARIMA untuk memperoleh model terbaik 
        serta menghasilkan prediksi harga yang akurat dan stabil. -->

        Sistem ini digunakan untuk menghasilkan prediksi harga 
<span class="highlight-text">Cabe Rawit Merah</span> 
di Kota Bandung berdasarkan data historis guna memperoleh estimasi harga periode selanjutnya.

    </p>
</div>

<!-- FORM SECTION -->
<div class="container form-wrapper">
    <div class="row justify-content-center">

        <div class="col-lg-9">

            <div class="card shadow custom-card border-0">
                <div class="card-body p-4">

                    <h5 class="mb-4 fw-semibold">
                        Tahapan
                    </h5>

                    <!-- STEP INFO -->
                    <!-- STEP INFO -->
                    <div class="row mb-3 g-3">
                        <div class="col-md-4">
                            <div class="step-box fs-7">
                                1️⃣ Pilih Dataset
                                <div class="small text-muted mt-1">
                                    Data historis harga 
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="step-box fs-7">
                                2️⃣ Detail Kinerja Model
                                <div class="small text-muted mt-1">
                                    Spesifikasi parameter serta hasil pengujian akurasi model
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="step-box fs-7">
                                3️⃣ Prediksi Harga
                                <div class="small text-muted mt-1">
                                    Prediksi harga untuk periode selanjutnya
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row align-items-end">

                        <div class="col-md-8">
                            <label class="form-label small text-muted">
                                Pilih Dataset 
                            </label>
                            <select id="fileSelect" 
                                    class="form-control custom-select">
                            </select>
                        </div>

                        <div class="col-md-4">
                            <button id="btnSplit" 
                                    class="btn btn-main text-white w-100">
                                Jalankan
                            </button>
                        </div>

                    </div>

                </div>
            </div>

        </div>

    </div>
</div>


<!-- ========================= -->
<!-- HASIL SPLIT & STL -->
<!-- ========================= -->

<div class="container mt-5">

    <div class="accordion mt-4 d-none" id="accordionPreview">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapsePreview"
                        style="border:0; box-shadow:none;">
                    Ringkasan Pembagian Dataset
                </button>
            </h2>
            <div id="collapsePreview" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div id="hasil"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mt-3 d-none" id="accordionSTL">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseSTL">
                    Hasil Analisis Musiman (STL)
                </button>
            </h2>
            <div id="collapseSTL" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div id="hasilSTL"></div>
                </div>
            </div>
        </div>
    </div>

</div>


<!-- ========================= -->
<!-- SARIMA -->
<!-- ========================= -->

<div class="container mt-4">

    <button id="btnSarima"
            class="btn text-white d-none"
            onclick="btnSarimaTrain()"
            style="background-color: #00849B;">
        Jalankan Pencarian Model Terbaik (SARIMA Grid)
    </button>

    <div id="hasilSarima" class="mt-4"></div>

</div>


<!-- ========================= -->
<!-- FORWARD PRED -->
<!-- ========================= -->

<div class="container mt-4">

    <button id="btnForwardPred"
            class="btn d-none text-white"
            onclick="btnForwardPred()"
            style="background-color: #00849B;">
        Jalankan Prediksi Harga
    </button>

    <div  id="hasilForwardPred" class="mt-4"></div>

</div>


<!-- ========================= -->
<!-- GLOBAL LOADER -->
<!-- ========================= -->

<div id="globalLoader"
     class="d-none"
     style="position:fixed;
            inset:0;
            background:rgba(255,255,255,0.6);
            backdrop-filter: blur(4px);
            z-index:9999;
            display:flex;
            align-items:center;
            justify-content:center;">

    <div class="text-center p-4 bg-white shadow rounded-4">
        <div class="spinner-border mb-3"
             style="width:2rem;height:2rem;color:#0093AD;"></div>
        <div class="fw-semibold">Sedang Memproses Data...</div>
        <small class="text-muted">
            Analisis model dan prediksi harga sedang dijalankan
        </small>
    </div>
</div>


<!-- Baru -->


<div id="hasilDynamicForward"></div>
<!-- EndBaru -->



<!-- Modal -->
<div class="modal fade " id="modalPrediksi" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered ">
        <div class="modal-content border-0 ">
            <div class="modal-header">
                <h5 class="modal-title">Tambahkan Periode Prediksi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body  ">
                <label class="form-label">Jumlah Periode Tambahan</label>
                <input type="number" id="inputExtraStep" class="form-control"  min="0" value="0" >
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Batal
                </button>
                <button id="btn-runForward" class="btn text-white"
                        onclick="runDynamicForward()"
                        style="background-color: #0093AD;">
                    Prediksi
                </button>
            </div>

        </div>
    </div>
</div>




{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>


<script>
let lastTestData = [];
let lastGridModels = [];

let lastTestLabels = [];
let lastPredLabels = [];



$(document).ready(function(){

    $.get("/get-files", function(files){

        $("#fileSelect").append(`<option value="">-- Pilih File --</option>`);

        files.forEach(function(file){
            $("#fileSelect").append(`<option value="${file}">${file}</option>`);
        });

    });

});

$("#btnSplit").click(function(){

    const file = $("#fileSelect").val();

    if(!file){
        alert("Pilih file dulu");
        return;
    }

    // $("#btnSplit").prop("disabled", true).text("Memproses...");
    $("#btnSplit")
        .prop("disabled", true)
        .html(`<span class="spinner-border spinner-border-sm me-2"></span>Memproses...`);

    showLoader();


    $.ajax({
        url: "/split-data-auto",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ file: file }),
        success: function(res){
            
            // $("#btnSplit").prop("disabled", false).text("Submit");

            if(!res.success){
                $("#hasil").html(`<div class="alert alert-danger">${res.message}</div>`);
                return;
            }

            let html = `
                <div class="alert alert-info">
                    File: ${res.filename}<br>
                    Train: ${res.train_len}<br>
                    Test: ${res.test_len}<br>
                    Prediksi: ${res.pred_len}
                </div>
            `;

            html += buildTable("TRAIN", res.train);
            html += buildTable("TEST", res.test);
            html += buildTable("PREDIKSI", res.pred);

            // Kesimpulan
            lastTestLabels = res.test.map(d => d.bulan);
            lastPredLabels = res.pred.map(d => d.bulan);
            // Kesimpulan


            $("#hasil").html(html);

            // ===== STL RESULT =====
            let stlHtml = `
                <div class="alert alert-success">
                    Rekomendasi: ${res.recommendation}
                    <br>Best s : ${res.best_s}
                </div>
            `;

            stlHtml += `
                <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>s (periode berulang)</th>
                        <th>Strength</th>
                        <!--<th>Adjusted</th>-->
                    </tr>
                </thead>
                <tbody>
            `;

            res.stl_results.forEach(function(r){
                stlHtml += `
                    <tr>
                        <td>${r.s}</td>
                        <td>${r.seasonal_strength}</td>
                        <!--<td>${r.adjusted_strength}</td>-->
                    </tr>
                `;
            });



            stlHtml += "</tbody></table>";

            $("#hasilSTL").html(stlHtml);
            
            runSarimaGrid();
        },
        error(){
            
            $("#btnSplit").prop("disabled", false).text("Jalankan");
            $("#hasilSarima").html(
                `<div class="alert alert-danger">
                    Server Down, Coba Ulangi Beberapa Saat Lagi.
                </div>`
            );
            hideLoader();
            
        }
    });

});

function buildTable(title, data){

    let html = `
        <h5 class="mt-4">DATA ${title}</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Bulan</th>
                    <th>Harga</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(function(d,i){
        html += `
            <tr>
                <td>${i+1}</td>
                <td>${d.bulan}</td>
                <td>${formatRupiah(d.harga)}</td>

                </tr>
                `;
                // <td>${Number(d.harga).toFixed(2)}</td>
    });

    html += "</tbody></table>";

    return html;
}

</script>


<script>

let lastFilteredModels = [];


// $("#btnSarima").click(function(){

function runSarimaGrid() {



    $("#btnSarima").prop("disabled", true).text("Processing...");
    $("#hasilSarima").html("");

    $.ajax({
        url: "/sarima-grid",
        type: "POST",
        success: function(res){

            

            $("#btnSarima").prop("disabled", false)
                           .text("Jalankan SARIMA Grid");

            if(!res.success){
                $("#hasilSarima").html(
                    `<div class="alert alert-danger">${res.message}</div>`
                );
                return;
            }

            const test = res.test || [];
            
            

            const filteredModels = (res.models || []).filter(m => 
                parseFloat(m.MAPE) <= 10
                // parseFloat(m.MAPE) <= 1000
            );
            lastFilteredModels = filteredModels;
            
            // Kesimpulan
            lastTestData = test;
            lastGridModels = filteredModels;
            // Kesimpulan



            if(filteredModels.length === 0){
                $("#btnSplit").prop("disabled", false).text("Jalankan");
                hideLoader();
                $("#hasilSarima").html(
                    `<div class="alert alert-warning">
                        Tidak ada model dengan MAPE ≤ 10%
                    </div>`
                );
                return;
            }

            let html = `<div class="accordion" id="accordionSarima">`;

            /* ================= RANKING ================= */
            html += `
            <div class="accordion-item mb-3 d-none">
                <h2 class="accordion-header">
                    <button class="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseRanking">
                        Evaluasi Model (Train vs Test)
                    </button>
                </h2>
                <div id="collapseRanking"
                     class="accordion-collapse collapse show">
                    <div class="accordion-body p-3">
                        <table class="table table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center">No</th>
                                    <th class="text-center">Order</th>
                                    <th class="text-center">Seasonal</th>
                                    <th class="text-center">MAPE</th>
                                    <th class="text-center">MSE</th> 
                                    <th class="text-center">RMSE</th>
                                    <th class="text-center d-none">R²</th>
                                    <th class="text-center d-none">Corr</th>
                                    <th class="text-center d-none">AIC</th>
                                    <th class="text-center">White Noise (p-value)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            filteredModels.forEach(function(m,i){
                // <tr class="${i===0?'table-success fw-bold':''}">
                html += `
                    <tr class="">
                        <td class="text-center">${i+1}</td>
                        <td class="text-center">${m.order.join(",")}</td>
                        <td class="text-center">${m.seasonal.join(",")}</td>
                        <td class="text-center">${m.MAPE}%</td>
                        <td class="text-center">${m.MSE}</td>   
                        <td class="text-center">${m.RMSE}</td>
                        <td class="text-center  d-none">${m.R2}</td>
                        <td class="text-center  d-none">${m.CORR}</td>
                        <td class="text-center d-none">${m.AIC}</td>
                        <td class="text-center">${m.white_noise ? m.white_noise.toFixed(4) : "-"}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            `;

            /* ================= DETAIL MODEL ================= */
            html += `
            <div class="accordion-item mb-3 d-none">
                <h2 class="accordion-header">
                    <button class="accordion-button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseCharts">
                        Grafik Evaluasi Model (Train vs Test)
                    </button>
                </h2>
                <div id="collapseCharts"
                     class="accordion-collapse collapse show">
                    <div class="accordion-body">
                        <div class="accordion">
            `;

            filteredModels.forEach(function(m,i){

                html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button"
                            data-bs-toggle="collapse"
                            data-bs-target="#model-${i}">
                            Model #${i+1} (Train vs Aktual)|
                            SARIMA(${m.order.join(",")})
                            (${m.seasonal.join(",")})
                            | MAPE: ${m.MAPE}% 
                            | RMSE: ${m.RMSE}
                            <!--| AIC: ${m.AIC}-->
                            | White Noise: ${m.white_noise ? m.white_noise.toFixed(4) : "-"}
                        </button>
                    </h2>

                    <div id="model-${i}"
                         class="accordion-collapse collapse show">
                        <div class="accordion-body">

                            <div class="row">

                                <div class="col-md-6">
                                    <canvas id="canvas-${i}"></canvas>
                                </div>

                                <div class="col-md-6">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Periode</th>
                                                <th>Aktual</th>
                                                <th>Forecast</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${test.map((val,idx)=>{
                                                const fc = m.forecast[idx] ?? null;
                                                return `
                                                <tr>
                                                    <td>${lastTestLabels[idx]}</td>
                                                    <td>${formatRupiah(val)}</td>
                                                    <td>${fc !== null ? formatRupiah(fc) : "-"}</td>
                                                    <td>${fc !== null ? formatRupiah(val - fc) : "-"}</td>

                                                </tr>`;
                                            }).join("")}
                                        </tbody>
                                    </table>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            </div>
            </div>
            `;

            $("#hasilSarima").html(html);

            /* ================= DRAW CHART ================= */

            filteredModels.forEach(function(m,i){

                const labels = lastTestLabels;


                new Chart(
                    document.getElementById(`canvas-${i}`),
                    {
                        type:"line",
                        data:{
                            labels: labels,
                            datasets:[
                                {
                                    label:"Aktual (Test)",
                                    data: test,
                                    borderDash:[5,5]
                                },
                                {
                                    label:"Forecast",
                                    data: m.forecast.slice(0,test.length)
                                }
                            ]
                        },
                        options:{
                            responsive:true,
                            animation:false
                        }
                    }
                );
            });
            btnForwardPred();
            runDynamicForward();

        },
        error: function(e){
            $("#btnSarima").prop("disabled", false)
                           .text("Jalankan");

            $("#hasilSarima").html(
                `<div class="alert alert-danger">
                    Server Down, Coba Ulangi Beberapa Saat Lagi.
                </div>`
            );

            $("#btnSplit").prop("disabled", false).text("Jalankan");
            hideLoader();            
        }

        // error: function(xhr, status, error) {
        //     $("#btnSarima").prop("disabled", false)
        //                 .text("Jalankan SARIMA Grid");

        //     let errorMessage = "";

        //     if (xhr.responseJSON && xhr.responseJSON.message) {
        //         errorMessage = xhr.responseJSON.message;
        //     } else if (xhr.responseText) {
        //         errorMessage = xhr.responseText;
        //     } else if (error) {
        //         errorMessage = error;
        //     }

        //     $("#hasilSarima").html(
        //         `<div class="alert alert-danger">
        //             ${errorMessage}
        //         </div>`
        //     );

        //     $("#btnSplit").prop("disabled", false).text("Jalankan");
        //     hideLoader();
        // }

    });

    
};
</script>



<script>
    // $("#btnForwardPred").click(function(){
function btnForwardPred(){

    if(lastFilteredModels.length === 0){
        alert("Jalankan SARIMA Grid dulu");
        return;
    }

    $("#btnForwardPred")
        .prop("disabled", true)
        .text("Processing...");

    $.ajax({
        url: "/sarima-forward-pred",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            models: lastFilteredModels
        }),
        success: function(res){

            $("#btnSplit").prop("disabled", false).text("Jalankan");
            hideLoader();

            $("#btnForwardPred")
                .prop("disabled", false)
                .text("Jalankan Evaluasi Model (Prediksi)");

            if(!res.success){
                $("#hasilForwardPred").html(
                    `<div class="alert alert-danger">${res.message}</div>`
                );
                return;
            }

            const actualPred = res.actual_pred || [];

            // ==== ambil, filter, urutkan ====
            let models = res.models || [];

            models = models.map(m => ({
                ...m,
                MAPE_PRED: Number(m.MAPE_PRED)
            }));

            // models = models
            //     .filter(m => m.MAPE_PRED < 10)
            //     .sort((a,b) => a.MAPE_PRED - b.MAPE_PRED);

            if(models.length === 0){
                $("#hasilForwardPred").html(`
                    <div class="alert alert-warning">
                        Tidak ada model dengan MAPE_PRED &lt; 10%
                    </div>
                `);
                return;
            }

            let html = `
            <div class="accordion d-none" id="accordionForwardWrapper">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseForwardAll">
                            Evaluasi model (model validation Prediksi)
                        </button>
                    </h2>

                    <div id="collapseForwardAll"
                         class="accordion-collapse collapse show">
                        <div class="accordion-body">
            `;

            /* ================= TABLE ================= */

            html += `
            <div class="card mb-4 shadow-none">
                <div class="card-header fw-bold">
                    Tabel Evaluasi Model (Train vs Test)
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Order</th>
                                <th>Seasonal</th>
                                <th>MAPE Test</th>
                                <th>MSE Test</th>    
                                <th>MAPE Pred</th>
                                <th>MSE Pred</th>    
                                <th>RMSE Pred</th>
                                <th class=" d-none">R² Pred</th>
                                <th class=" d-none">Corr Pred</th>


                            </tr>
                        </thead>
                        <tbody>
            `;

            models.forEach((m,i)=>{
                html += `
                <tr class="${i===0?'table-success fw-bold':''}">
                    <td>${i+1}</td>
                    <td>${m.order.join(",")}</td>
                    <td>${m.seasonal.join(",")}</td>
                    <td>${m.MAPE_TEST}%</td>
                    <td>${m.MSE_TEST}</td>     
                    <td>${m.MAPE_PRED}%</td>
                    <td>${m.MSE_PRED}</td>     
                    <td>${m.RMSE_PRED}</td>
                    <td class=" d-none">${m.R2_PRED}</td>
                    <td class=" d-none">${m.CORR_PRED}</td>


                </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            </div>
            `;

            /* ================= GRAFIK PER MODEL ================= */

            models.forEach((m,i)=>{

                html += `
                <div class="card mb-4 shadow-none">
                    <div class="card-header fw-bold">
                        Model #${i+1} |
                        SARIMA(${m.order.join(",")})
                        (${m.seasonal.join(",")})
                        | MAPE_PRED: ${m.MAPE_PRED}%
                    </div>

                    <div class="card-body">

                        <div class="row">

                            <div class="col-md-6">
                                <canvas id="forward-canvas-${i}"></canvas>
                            </div>

                            <div class="col-md-6">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Periode</th>
                                            <th>Aktual</th>
                                            <th>Forecast</th>
                                            <th>Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${actualPred.map((val,idx)=>{
                                            const fc = m.forecast[idx] ?? null;
                                            return `
                                            <tr>
                                                <td>${lastPredLabels[idx]}</td>
                                                <td>${formatRupiah(val)}</td>
                                                <td>${fc !== null ? formatRupiah(fc) : "-"}</td>
                                                <td>${fc !== null ? formatRupiah(val - fc) : "-"}</td>

                                            </tr>`;
                                        }).join("")}
                                    </tbody>
                                </table>
                            </div>

                        </div>

                    </div>
                </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            </div>
            `;

            $("#hasilForwardPred").html(html);

            /* ================= DRAW CHART ================= */

            models.forEach((m,i)=>{

            const labels = lastPredLabels;

            new Chart(
                document.getElementById(`forward-canvas-${i}`),
                {
                    type:"line",
                    data:{
                        labels: labels,
                        datasets:[
                            {
                                label:"Aktual (GLOBAL_PRED)",
                                data: actualPred,
                                borderDash:[5,5]
                            },
                            {
                                label:"Forecast",
                                data: m.forecast
                            }
                        ]
                    },
                    options:{
                        responsive:true,
                        animation:false
                    }
                }
            );

        });







            // Kesimpulan
            /* ================= KESIMPULAN MODEL TERBAIK ================= */
/* ================= KESIMPULAN MODEL TERBAIK ================= */

/* ================= KESIMPULAN MODEL TERBAIK ================= */

/* ================= KESIMPULAN MODEL TERBAIK ================= */

const bestForwardModel = models[0];

const bestTrainModel = lastGridModels.find(m =>
    m.order.join(",") === bestForwardModel.order.join(",") &&
    m.seasonal.join(",") === bestForwardModel.seasonal.join(",")
);

let summaryHtml = `
<div class="accordion my-4" id="accordionKesimpulan">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseKesimpulan">
                Detail Kinerja Model
            </button>
        </h2>

        <div id="collapseKesimpulan"
             class="accordion-collapse collapse show">
            <div class="accordion-body">

                <div class="row mt-1 mx-1 py-3" style="background-color:#fff;">
                    
                    <!-- LEFT SIDE -->
                    <div class="col-12 col-lg-5">

                        <div class="card border-0 shadow-none rounded-1"
                            style="border-radius:10px;">
                            <div class="card-body rounded-3" style="background-color:#fbfbfb;">

                                <h5 class="mb-4" style="font-weight:600;">
                                    Parameter Model SARIMA Terpilih
                                </h5>

                                <div class="row text-center g-3">

                                    <div class="col-6">
                                        <div class="p-3 shadow-sm"
                                            style="background:#fff; border-radius:10px;">
                                            <div style="font-size:13px; color:#6c757d;">
                                                Order (p,d,q)
                                            </div>
                                            <div style="font-size:20px; font-weight:600;">
                                                (${bestTrainModel.order.join(",")})
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        <div class="p-3 shadow-sm"
                                            style="background:#fff; border-radius:10px;">
                                            <div style="font-size:13px; color:#6c757d;">
                                                Seasonal (P,D,Q,s)
                                            </div>
                                            <div style="font-size:20px; font-weight:600;">
                                                (${bestTrainModel.seasonal.join(",")})
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="mt-4"
                                    style="font-size:18px; color:#6c757d;">
                                    Model:
                                    <span style="font-weight: bold  ; color:#00849B;">
                                        SARIMA (${bestTrainModel.order.join(",")})
                                        (${bestTrainModel.seasonal.join(",")})
                                    </span>
                                </div>

                            </div>
                        </div>

                    </div>

                    <!-- RIGHT SIDE -->
                    <div class="col-12 col-lg-7">
                        <div class="card border-0 shadow-none rounded-1 "
                            style="border-radius:16px;">
                            <div class="card-body rounded-3" style="background-color:#fbfbfb;">

                                <h5 class="mb-4" style="font-weight:600;">
                                    Hasil Pengujian Model
                                </h5>

                                <div class="row g-3">

                                <!-- MAPE -->
                                <div class="col-12">
                                    <div class="row g-2">

                                        <div class="col-4">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px; ">
                                                <div style="font-size:12px; color:#6c757d;">MAPE</div>
                                                <div style="font-size:22px; font-weight:600;">
                                                    ${bestTrainModel.MAPE}%
                                                </div>
                                                <div style="font-size:11px; color:#999;">
                                                    Mean Absolute Percentage Error
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-8">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px;">
                                                
                                                <div style="font-size:13px; font-weight:500; margin-bottom:6px;">
                                                    Rata-rata Kesalahan Prediksi
                                                </div>

                                                <div style="font-size:13px; line-height:1.6;">
                                                    • ≤ 10%  → Rata-rata kesalahan rendah <br>
                                                    • 10% – 20% → Rata-rata kesalahan sedang <br>
                                                    • > 20%  → Rata-rata kesalahan tinggi
                                                </div>


                                            </div>
                                        </div>

                                    </div>
                                </div>


                                <!-- MSE -->
                                <div class="col-12 d-none">
                                    <div class="row g-2">

                                        <div class="col-4">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px; ">
                                                <div style="font-size:12px; color:#6c757d;">MSE</div>
                                                <div style="font-size:20px; font-weight:600;">
                                                    ${bestTrainModel.MSE}
                                                </div>
                                                <div style="font-size:11px; color:#999;">
                                                    Mean Squared Error
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-8">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px;">
                                                <div style="font-size:13px; line-height:1.6;">
                                                    Mengukur besar kesalahan model dalam bentuk kuadrat. <br>
                                                    Semakin kecil nilainya → performa model semakin baik.
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>


                                <!-- RMSE -->
                                <div class="col-12">
                                    <div class="row g-2">

                                        <div class="col-4">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px; ">
                                                <div style="font-size:12px; color:#6c757d;">RMSE</div>
                                                <div style="font-size:20px; font-weight:600;">
                                                    ${bestTrainModel.RMSE}
                                                </div>
                                                <div style="font-size:11px; color:#999;">
                                                    Root Mean Squared Error
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-8">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px;">
                                                <div style="font-size:13px; line-height:1.6;">
                                                    Rata-rata selisih prediksi terhadap nilai aktual sekitar <br>
                                                    <strong>Rp ${bestTrainModel.RMSE}</strong><br>
                                                    Semakin kecil → prediksi semakin mendekati data Aktual.
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>


                                <!-- WHITE NOISE -->
                                <div class="col-12">
                                    <div class="row g-2">

                                        <div class="col-4">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px; ">
                                                <div style="font-size:12px; color:#6c757d;">White Noise</div>
                                                <div style="font-size:20px; font-weight:600;">
                                                    ${bestTrainModel.white_noise 
                                                        ? bestTrainModel.white_noise.toFixed(4) 
                                                        : "-"}
                                                </div>
                                                <div style="font-size:11px; color:#999;">
                                                    Uji Ljung-Box (p-value)
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-8">
                                            <div class="p-3 h-100 shadow-sm"
                                                style="background:#fff; border-radius:12px;">
                                                                            

                                                <div style="font-size:13px; line-height:1.7; color:#495057;">
                                                    Menguji apakah model sudah menangkap seluruh pola pada data.
                                                    <br>
                                                    • p-value > 0.05 → pola sudah tertangkap dengan baik.
                                                    <br>
                                                    • p-value ≤ 0.05 → masih ada pola yang belum tertangkap.
                                                </div>


                                            </div>
                                        </div>


                                    </div>
                                </div>

                            </div>

                            </div>
                        </div>
                    </div>

                </div>
                <hr>
                <!-- TRAIN SECTION -->
                <div class="row mb-5 mt-3 px-4">
                    <div class="col-md-8">
                        <h5 class="mt-3">Grafik Model Train vs Aktual</h5>
                        <canvas id="best-train-chart"></canvas>
                    </div>

                    <div class="col-md-4">
                        <h5 class="mt-5">Table Detail (Model Train vs Aktual)</h5>
                        <table class="table mt-3">
                            <thead class="table-light">
                                <tr>
                                    <th>Periode</th>
                                    <th>Aktual</th>
                                    <th>Forecast</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lastTestData.map((val,idx)=>{
                                    const fc = bestTrainModel.forecast[idx] ?? null;
                                    return `
                                    <tr>
                                        <td>${lastTestLabels[idx]}</td>
                                        <td>${formatRupiah(val)}</td>
                                        <td>${fc !== null ? formatRupiah(fc) : "-"}</td>
                                    </tr>`;
                                }).join("")}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
`;

/* ================= ACCORDION PREDIKSI ================= */

summaryHtml += `
<div class="accordion my-4 d-none" id="accordionPrediksi">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button "
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapsePrediksi">
                PREDIKSI HARGA
            </button>
        </h2>

        <div id="collapsePrediksi"
             class="accordion-collapse collapse show">
            <div class="accordion-body">

                <div class="row mb-4 px-2">

                    <div class="col-md-6">
                        <h5 class="mt-3">Grafik Prediksi Harga</h5>
                        <div style="position:relative; height:350px;">
                            <canvas id="best-forward-chart"></canvas>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="mt-4 mb-4">Table Prediksi Harga</h5>
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>Periode</th>
                                    <th>Aktual</th>
                                    <th>Forecast</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${actualPred.map((val,idx)=>{
                                    const fc = bestForwardModel.forecast[idx] ?? null;
                                    return `
                                    <tr>
                                        <td>${lastPredLabels[idx]}</td>
                                        <td>${formatRupiah(val)}</td>
                                        <td>${fc !== null ? formatRupiah(fc) : "-"}</td>
                                        <td>${fc !== null ? formatRupiah(val - fc) : "-"}</td>
                                    </tr>`;
                                }).join("")}
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
`;

$("#hasilForwardPred").append(summaryHtml);

/* ===== DRAW CHART TRAIN ===== */

if(bestTrainModel){
    new Chart(
        document.getElementById("best-train-chart"),
        {
            type:"line",
            data:{
                labels: lastTestLabels,
                datasets:[
                    {
                        label:"Aktual (Test)",
                        data: lastTestData,
                        borderDash:[5,5]
                    },
                    {
                        label:"Forecast (Model Train)",
                        data: bestTrainModel.forecast.slice(0,lastTestData.length)
                    }
                ]
            },
            options:{
                responsive:true,
                animation:false,
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString("id-ID");
                            }
                        }
                    }
                }
            }

        }
    );
}


/* ===== DRAW CHART FORWARD ===== */

new Chart(
    document.getElementById("best-forward-chart"),
    {
        type:"line",
        data:{
            labels: lastPredLabels,
            datasets:[
                {
                    label:"Aktual",
                    data: actualPred,
                    borderDash:[5,5]
                },
                {
                    label:"Forecast",
                    data: bestForwardModel.forecast
                }
            ]
        },
        options:{
            responsive:true,
            animation:false,
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString("id-ID");
                        }
                    }
                }
            }
        }

    }
);


            // Kesimpulan







            

        },
        error:function(){

            $("#btnForwardPred")
                .prop("disabled", false)
                .text("Jalankan Evaluasi Model (Prediksi)");

            $("#hasilForwardPred").html(`
                <div class="alert alert-danger">
                    Terjadi error saat forward
                </div>
            `);

            $("#btnSplit").prop("disabled", false).text("Jalankan");
            hideLoader();
            $("#inputExtraStep").val(0);
            $("#btn-runForward").prop("disabled", false).text("Prediksi");
            
        }
    });

};

</script>

<script>
    function formatRupiah(angka){
    return "Rp " + Number(angka).toLocaleString("id-ID", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

</script>


<script>
    function showLoader(){
    $("#globalLoader").removeClass("d-none");
}

function hideLoader(){
    $("#globalLoader").addClass("d-none");
}

</script>




<script>
    function runDynamicForward(){

    if(lastFilteredModels.length === 0){
        alert("Jalankan SARIMA Grid dulu");
        return;
    }

    $("#btn-runForward")
        .prop("disabled", true)
        .html(`<span class="spinner-border spinner-border-sm me-2"></span>Memproses...`);

    const extraStep = Number($("#inputExtraStep").val());

    $.ajax({
        url: "/sarima-forward-dynamic",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            model: lastFilteredModels[0],
            extra_step: extraStep
        }),
        success: function(res){

            $("#btnSplit").prop("disabled", false).text("Jalankan");
            hideLoader();

            $("#btn-runForward").prop("disabled", false).text("Prediksi");

            // === HIDE MODAL ===
            var modalElement = $('#modalPrediksi')[0];
            var modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
            modalInstance.hide();

            if(!res.success){
                $("#hasilDynamicForward").html(`<div class="alert alert-danger">${res.message}</div>`);

                $("#inputExtraStep").val(0);
                modalInstance.hide();

                return;
            }

            // Hide Modal
            modalInstance.hide();

            let forecast = res.forecast;
            let actual = res.actual;

            // ===== EXTEND ACTUAL =====
            let actualExtended = [...actual];
            while(actualExtended.length < forecast.length){
                actualExtended.push(null);
            }

            // ===== EXTEND LABEL =====
            let labels = [...lastPredLabels];

            if(forecast.length > labels.length){

                let lastDate = moment(labels[labels.length - 1], "MM/YYYY");

                for(let i = labels.length; i < forecast.length; i++){
                    lastDate = lastDate.add(1, "month");
                    labels.push(lastDate.format("MM/YYYY"));
                }
            }

            // ===== BUILD TABLE ROW =====
            let tableRows = "";

            labels.forEach((label, idx)=>{

                let actualVal = actualExtended[idx];
                let forecastVal = forecast[idx];

                tableRows += `
                    <tr>
                        <td>${label}</td>
                        <td class="col-aktual">${actualVal !== null ? formatRupiah(actualVal) : "-"}</td>
                        <td class="col-forecast">${forecastVal !== undefined ? formatRupiah(forecastVal) : "-"}</td>
                        <td class="col-error">
                            ${(actualVal !== null && forecastVal !== undefined)
                                ? formatRupiah(actualVal - forecastVal)
                                : "-"}
                        </td>
                    </tr>
                `;
            });

            // ===== RENDER ACCORDION =====
            $("#hasilDynamicForward").html(`
            <div class="container">
                <div class="accordion mb-4 mt-5 " id="accordionDynamicPrediksi">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapseDynamicPrediksi">
                                PREDIKSI HARGA
                            </button>
                        </h2>


                        <div id="collapseDynamicPrediksi"
                             class="accordion-collapse collapse show">
                            <div class="accordion-body">

                                <div class="row mb-4 px-3">

                                    <div class="col-md-6">
                                        <h5 class="mt-3">Grafik Prediksi</h5>
                                        <div style="position:relative; height:350px;">
                                            <canvas id="dynamicChart"></canvas>
                                        </div>
                                    </div>

                                    <div class="col-md-6">                                                                                
                                        <div class="d-flex justify-content-between">
                                            <h5 class="mt-4 mb-4">Table Prediksi </h5>
                                            <div class="text-end mt-2">
                                                <button class="btn "
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalPrediksi"
                                                        title="Tambah Prediksi"
                                                        style="background-color: #0093AD;color: #fff;">

                                                    <i class="bi bi-graph-up-arrow"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <table class="table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Periode</th>
                                                    <th class="col-aktual">Aktual</th>
                                                    <th class="col-forecast">Forecast</th>
                                                    <th class="col-error">Error</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tableRows}
                                            </tbody>
                                        </table>
                                    </div>

                                </div>

                                <div class="px-3 d-none">
                                    <strong>MAPE:</strong> ${res.MAPE}% &nbsp; | &nbsp;
                                    <strong>RMSE:</strong> ${res.RMSE}
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>    
            `);

            // ===== DESTROY CHART LAMA =====
            let oldChart = Chart.getChart("dynamicChart");
            if(oldChart){
                oldChart.destroy();
            }

            // ===== DRAW CHART =====
            new Chart(
                document.getElementById("dynamicChart"),
                {
                    type:"line",
                    data:{
                        labels: labels,
                        datasets:[
                            {
                                label:"Aktual",
                                data: actualExtended,
                                borderDash:[5,5]
                            },
                            {
                                label:"Forecast",
                                data: forecast
                            }
                        ]
                    },
                    options:{
                        responsive:true,
                        animation:false,
                        plugins:{
                            legend:{
                                onClick: function(e, legendItem, legend){

                                    const chart = legend.chart;
                                    const index = legendItem.datasetIndex;

                                    // === TOGGLE DATASET YANG BENAR ===
                                    const meta = chart.getDatasetMeta(index);
                                    meta.hidden = meta.hidden === null
                                        ? !chart.data.datasets[index].hidden
                                        : null;

                                    chart.update();

                                    // === CEK VISIBILITY ===
                                    const aktualVisible = chart.isDatasetVisible(0);
                                    const forecastVisible = chart.isDatasetVisible(1);

                                    $('.col-aktual').toggleClass('d-none', !aktualVisible);
                                    $('.col-forecast').toggleClass('d-none', !forecastVisible);

                                    // ERROR hanya muncul jika keduanya tampil
                                    if(aktualVisible && forecastVisible){
                                        $('.col-error').removeClass('d-none');
                                    } else {
                                        $('.col-error').addClass('d-none');
                                    }
                                }
                            }
                        },

                        scales:{
                            y:{
                                ticks:{
                                    callback:function(value){
                                        return value.toLocaleString("id-ID");
                                    }
                                }
                            }
                        }
                    }


                }
            );

        },
        error(){
            $("#btnSplit").prop("disabled", false).text("Jalankan");
            hideLoader();
            $("#inputExtraStep").val(0);
            $("#btn-runForward").prop("disabled", false).text("Prediksi");
        }
    });
}

</script>

{% endblock %}
